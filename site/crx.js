"use strict;";Math.sgn=function(c){return(c<0)?-1:((c>0)?1:0)};Math.clamp=function(f,e,c){return Math.max(Math.min(f,c),e)};let Constants={G:-9.8};let Vector2d=function(){let _=Object.create(null);let makeVector=function(c,e){let vector=Object.create(_);vector.x=c;vector.y=e;return vector};_.a=function(c){return makeVector(c[0],c[1])};_.xy=function(c,e){return makeVector(c,e)};_.v=function(c){return makeVector(c.x,c.y)};_.angle=function(c){return makeVector(Math.cos(c),Math.sin(c))};_.zero=function(){return makeVector(0,0)};_.one=function(){return makeVector(1,1)};_.add=function(c){return makeVector(this.x+c.x,this.y+c.y)};_.subtract=function(c){return makeVector(this.x-c.x,this.y-c.y)};_.scale=function(c){return makeVector(this.x*c,this.y*c)};_.dot=function(c){return(this.x*c.x)+(this.y*c.y)};_.cross=function(c){return(this.x*c.y)-(this.y*c.x)};_.normSq=function(){return this.dot(this)};_.norm=function(){return Math.sqrt(this.normSq())};_.normalize=function(){let norm=this.norm();this.copy(this.scale(1/norm));return norm};_.normalized=function(){return this.scale(1/this.norm())};_.perpendicular=function(){return makeVector(-this.y,this.x)};_.reflect=function(c,e){return c.subtract(e.scale(c.dot(e)*2))};_.toString=function(){return this.x+","+this.y};_.copy=function(c){this.x=c.x;this.y=c.y};return _}();let Particle=function(){let _=Object.create(null);_.reset=function(c){this.position=c;this.lastPosition=c;this.lastDeltaTime=0.001;this.velocity=Vector2d.zero();this.force=Vector2d.zero()};_.init=function(g,e,c,f){this.name=g;this.radius=c;this.mass=Math.PI*c*c*f;this.reset(e);return this};_.applyForce=function(c){this.force=this.force.add(c)};_.applyAcceleration=function(c){let force=c.scale(this.mass);this.applyForce(force)};_.applyDamping=function(c){this.applyAcceleration(this.velocity.scale(c/deltaTime))};_.applyFunction=function(c){c(this)};_.makeGeometry=function(c){this.svg=c.append("circle").attr("stroke-width",2/scale).attr("fill","red").attr("fill-opacity","1.0").attr("stroke","black").attr("stroke-opacity","1.0").attr("r",this.radius);return this};_.update=function(c){let velocityTerm=this.position.subtract(this.lastPosition).scale(c/this.lastDeltaTime);let accelerationTerm=this.force.scale(c*c/this.mass);this.force=Vector2d.zero();let deltaPosition=velocityTerm.add(accelerationTerm);let nextPosition=this.position.add(deltaPosition);this.velocity=deltaPosition.scale(1/c);this.lastDeltaTime=c;this.lastPosition=this.position;this.position=nextPosition};_.paint=function(){this.svg.attr("cx",this.position.x).attr("cy",this.position.y)};return _}();let Thing=function(){let _=Object.create(null);_.geometry=function(){let geometry=Object.create(null);geometry.density=3183;let computeRadius=function(c){return Math.sqrt(c/(Math.PI*geometry.density))};geometry.points=[{pt:Vector2d.xy(-0.05,0.05),radius:computeRadius(1)},{pt:Vector2d.zero(),radius:computeRadius(3)},{pt:Vector2d.xy(-0.05,-0.05),radius:computeRadius(1)},{pt:Vector2d.xy(0.1,0),radius:computeRadius(1)}];geometry.constraints=[[0,1],[1,2],[2,3],[3,0],[3,1]];geometry.computeXAxis=function(c){let midpoint=c[0].position.add(c[2].position).scale(0.5);return c[3].position.subtract(midpoint).normalized()};return geometry}();_.updateFrameOfReference=function(c){let particles=this.particles;let count=particles.length;let geometry=this.geometry;let position=Vector2d.zero();let totalMass=0;for(let i=0;i<count;++i){position=position.add(particles[i].position.scale(particles[i].mass));totalMass+=particles[i].mass}position=position.scale(1/totalMass);this.velocity=position.subtract(this.position).scale(1/c);this.position=position;let xAxis=geometry.computeXAxis(particles);let spinPosition=Math.atan2(xAxis.y,xAxis.x);let deltaSpinPosition=spinPosition-this.spinPosition;while(deltaSpinPosition>Math.PI){deltaSpinPosition-=(Math.PI*2)}while(deltaSpinPosition<-Math.PI){deltaSpinPosition+=(Math.PI*2)}this.spinVelocity=deltaSpinPosition/c;this.spinPosition=spinPosition;let shouldNormalize=true;if(shouldNormalize){let points=this.geometry.points;let yAxis=xAxis.perpendicular();for(let i=0;i<count;++i){particles[i].position=position.add(xAxis.scale(points[i].pt.x)).add(yAxis.scale(points[i].pt.y))}}};_.reset=function(e,c){let particles=this.particles;let count=particles.length;let points=this.geometry.points;let xAxis=Vector2d.angle(c);let yAxis=xAxis.perpendicular();for(let i=0;i<count;++i){particles[i].reset(e.add(xAxis.scale(points[i].pt.x)).add(yAxis.scale(points[i].pt.y)))}this.position=e;this.velocity=Vector2d.zero();this.spinPosition=c;this.spinVelocity=0;this.updateFrameOfReference(deltaTime)};_.init=function(f,e,c){this.name=f;this.mass=0;let particles=this.particles=[];let geometry=this.geometry;let points=geometry.points;for(let i=0,count=points.length;i<count;++i){let particle=Object.create(Particle).init(f+"-"+i,Vector2d.zero(),points[i].radius,geometry.density);this.mass+=particle.mass;particles.push(Manager.addParticle(particle))}let constraints=geometry.constraints;for(let i=0,count=constraints.length;i<count;++i){let a=constraints[i][0];let b=constraints[i][1];let id_a=particles[a].id;let id_b=particles[b].id;Manager.addConstraint(id_a,id_b,points[a].pt.subtract(points[b].pt).norm(),0.5,2)}this.reset(e,c);Manager.addThing(this);return this};_.makeGeometry=function(c){let particles=this.particles;let count=particles.length;for(let i=0;i<count;++i){particles[i].makeGeometry(c)}let pointsDesc=particles[0].position.toString();for(let i=1;i<count;++i){pointsDesc+=" "+particles[i].position.toString()}this.svg=c.append("polygon").attr("fill","red").attr("fill-opacity",0.33).attr("points",pointsDesc);this.svgLine=c.append("line").attr("stroke","blue").attr("stroke-opacity",0.33).attr("stroke-width",2/scale);return this};_.update=function(c){this.updateFrameOfReference(c)};_.paint=function(){this.svg.attr("transform","translate("+this.position.x+","+this.position.y+") rotate("+(this.spinPosition*(180/Math.PI))+", 0, 0)");this.svgLine.attr("transform","translate("+this.position.x+","+this.position.y+")").attr("x1",0).attr("y1",0).attr("x2",this.velocity.x).attr("y2",this.velocity.y);let particles=this.particles;for(let i=0,count=particles.length;i<count;++i){particles[i].paint()}};return _}();let Ship=function(){let _=Object.create(Thing);_.init=function(f,e,c){Object.getPrototypeOf(_).init.call(this,f,Vector2d.zero(),0);this.stunnedTime=0;totalMass=0;for(i=0;i<this.particles.length;++i){totalMass+=this.particles[i].mass}this.thrustRatio=1.9*(totalMass*-Constants.G);this.learn();this.reset(e,c);return this};_.learn=function(){this.reset(Vector2d.zero(),0);let spinVelocity=this.spinVelocity;let accumulator=0;let accumulatorCount=0;let scope=this;let report=function(){let stabilizationFrames=5;for(let i=0;i<stabilizationFrames;++i){Manager.update()}let spinAcceleration=Math.abs(scope.spinVelocity-spinVelocity)/(deltaTime*stabilizationFrames);spinVelocity=scope.spinVelocity;accumulator+=spinAcceleration;++accumulatorCount;return spinAcceleration};this.thrust(-1,1);report();this.thrust(-1,1);report();this.thrust(-1,1);report();this.thrust(1,-1);report();this.thrust(1,-1);report();this.thrust(1,-1);report();this.spinAcceleration=accumulator/accumulatorCount};_.thrust=function(e,c){if(this.stunnedTime<=0){let thrustScaling=this.thrustRatio;let orientationVector=Vector2d.angle(this.spinPosition);let leftThrustVector=orientationVector.scale(thrustScaling*e);let rightThrustVector=orientationVector.scale(thrustScaling*c);this.particles[0].applyAcceleration(leftThrustVector);this.particles[2].applyAcceleration(rightThrustVector)}};_.point=function(c){let targetSpinPosition=Math.atan2(c.y,c.x);let deltaSpinPosition=targetSpinPosition-this.spinPosition;while(deltaSpinPosition>Math.PI){deltaSpinPosition-=(Math.PI*2)}while(deltaSpinPosition<-Math.PI){deltaSpinPosition+=(Math.PI*2)}let deltaSpinPositionMagnitude=Math.abs(deltaSpinPosition);let maxRotationVelocity=Math.PI*2;let timeFactor=1/maxRotationVelocity;let timeToTargetSpinPosition=timeFactor*(1+deltaSpinPositionMagnitude);let velocityToTargetSpinPosition=(deltaSpinPosition/timeToTargetSpinPosition);let deltaVelocityNeeded=velocityToTargetSpinPosition-this.spinVelocity;let thrustNeeded=deltaVelocityNeeded/(this.spinAcceleration*0.5);let clampedThrust=Math.clamp(thrustNeeded,-1,1);this.thrust(-clampedThrust,clampedThrust);return deltaSpinPositionMagnitude};_.pointAt=function(c){let direction=c.subtract(this.position).normalized();this.point(direction)};let shipGo=function(f,e,g,c,h){let speed=e.norm()*c;let axis=(speed>0)?e.scale(1/speed):(f.velocity.normSq()>0?f.velocity.normalized():Vector2d.angle(f.spinPosition));let perp=axis.perpendicular();let axisComponent=Math.max(g,speed-(axis.dot(f.velocity)));let perpComponent=2*perp.dot(f.velocity);if((Math.abs(axisComponent)>0.001)||(Math.abs(perpComponent)>0.001)){let pointDirection=axis.scale(axisComponent).add(perp.scale(-perpComponent));let deltaSpinPosition=f.point(pointDirection);let thrustLevel=1-(deltaSpinPosition/(Math.PI*60/180));if(thrustLevel>0){thrustLevel=Math.pow(thrustLevel,h);f.thrust(thrustLevel,thrustLevel)}}else{f.point(axis)}};_.go=function(c){shipGo(this,c,0,1,2)};_.goTo=function(c){let targetVelocity=c.subtract(this.position);shipGo(this,targetVelocity,-1000,0.99,2)};_.stop=function(){shipGo(this,Vector2d.zero(),-1000,1,10)};_.stun=function(c){this.stunnedTime=Math.max(this.stunnedTime,c)};_.update=function(c){Object.getPrototypeOf(_).update.call(this,c);this.stunnedTime-=c};return _}();let ShipPID=function(){let _=Object.create(Ship);if(!("TWO_PI" in Math)){Math.TWO_PI=Math.PI*2}_.init=function(f,e,c){Object.getPrototypeOf(_).init.call(this,f,Vector2d.zero(),0);this.last={p:0,i:0};this.gain={p:6,i:0.025,d:40};return this};_.point=function(c){let conditionAngle=function(e){while(e>Math.PI){e-=(Math.TWO_PI)}while(e<-Math.PI){e+=(Math.TWO_PI)}return e};let targetPosition=Math.atan2(c.y,c.x);let currentPosition=this.spinPosition;let p=conditionAngle(targetPosition-currentPosition)/Math.PI;let last=this.last;let i=last.i+p;let d=p-last.p;console.log("p = "+p.toFixed(4)+", i = "+i.toFixed(4)+", d = "+d.toFixed(4));this.last={p:p,i:i};let thrustNeeded=(p*this.gain.p)+(i*this.gain.i)+(d*this.gain.d);let clampedThrust=Math.clamp(thrustNeeded,-1,1);this.thrust(-clampedThrust,clampedThrust);return Math.abs(p)};return _}();let Manager=function(){let _=Object.create(null);let particles=[];let nextParticle=0;let maxIterations=50;let stiffness=0.95;let maxConstraintError=0.00001;_.addParticle=function(c){let id=nextParticle++;particles.push(c);c.id=id;return c};_.removeParticle=function(c){delete particles[c]};let constraints=[];let nextConstraint=0;_.addConstraint=function(e,c,h,g,f){let id=nextConstraint++;constraints.push({a:e,b:c,length:h,damping:g,k:f});return id};_.removeConstraint=function(c){delete constraints[c]};let things=[];let nextThing=0;_.addThing=function(c){let id=nextThing++;things.push(c);return id};_.removeThing=function(c){delete things[c]};_.updateParticles=function(c){particles.forEach(function(g,e,f){g.update(c)});let i=0;let averageError=0;do{i++;let totalError=0;constraints.forEach(function(f,e,g){let a=particles[f.a];let b=particles[f.b];let delta=a.position.subtract(b.position);let deltaLength=f.length-delta.normalize();totalError+=Math.abs(deltaLength/f.length);let totalMass=a.mass+b.mass;a.position=a.position.add(delta.scale(stiffness*deltaLength*(a.mass/totalMass)));b.position=b.position.add(delta.scale(-stiffness*deltaLength*(b.mass/totalMass)))});averageError=totalError/constraints.length}while((i<maxIterations)&&(averageError>maxConstraintError))};_.updateThings=function(c){things.forEach(function(f,e,g){f.update(c)})};let gravity=null;_.setGravity=function(c){gravity=c};_.applyGravity=function(c){if(gravity!==null){particles.forEach(function(g,e,f){gravity(g,c)})}};_.update=function(){for(let i=0;i<subStepCount;++i){this.applyGravity(subDeltaTime);this.updateParticles(subDeltaTime)}this.updateThings(deltaTime)};_.paint=function(){things.forEach(function(e,c,f){e.paint()})};return _}();let GameKeys=function(){let _=Object.create(null);_.codes={backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,"break":19,capsLock:20,escape:27,pageUp:33,pageDown:34,end:35,home:36,leftArrow:37,upArrow:38,rightArrow:39,downArrow:40,insert:45,"delete":46,"0":48,"1":49,"2":50,"3":51,"4":52,"5":53,"6":54,"7":55,"8":56,"9":57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,leftWindow:91,rightWindow:92,select:93,numpad0:96,numpad1:97,numpad2:98,numpad3:99,numpad4:100,numpad5:101,numpad6:102,numpad7:103,numpad8:104,numpad9:105,multiply:106,add:107,subtract:109,decimalPoint:110,divide:111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numLock:144,scrollLock:145,colon:186,equalSign:187,comma:188,dash:189,period:190,forwardSlash:191,graveAccent:192,openBracket:219,backSlash:220,closeBracket:221,quote:222};_.init=function(){this.down=Object.create(null);let body=document.body;let scope=this;body.onkeydown=function(c){scope.down[c.keyCode]=true};body.onkeyup=function(c){scope.down[c.keyCode]=false}};_.isDown=function(c){return(c in this.down)?this.down[c]:false};return _}();let Container=function(){let _=Object.create(null);_.addGame=function(e,c){if(("games" in this)==false){this.games=Object.create(null);this.prefix="A".charCodeAt(0)}e="("+String.fromCharCode(this.prefix++)+") "+e;this.games[e]=c};_.getGameNames=function(){let gameNames=[];for(let gameName in this.games){gameNames.push(gameName)}gameNames.sort();return gameNames};_.getGame=function(c){return this.games[c]};return _}();let scale=1;let deltaTime=1/60;let subStepCount=4;let subDeltaTime=deltaTime/subStepCount;function preInitGame(c){let gameNames=c.getGameNames();let location=new String(window.location);console.log("URL ("+location+")");let targetIndex=location.search("#");if(targetIndex>=0){let target=location.substring(targetIndex+1);let targetGameIndex=target.toLowerCase().charCodeAt(0)-"a".charCodeAt(0);if((targetGameIndex>=0)&&(targetGameIndex<gameNames.length)){console.log("URL ("+location+") Target ("+target+") at index ("+targetGameIndex+")");gameNames=[gameNames[targetGameIndex]]}}if(gameNames.length>1){let gameList=document.createElement("div");gameList.className="gameList";gameList.id="gameList";for(let i=0;i<gameNames.length;++i){let link=document.createElement("div");link.innerHTML=gameNames[i];link.onclick=function(){this.parentNode.parentNode.removeChild(this.parentNode);initGame(c.getGame(this.innerHTML))};gameList.appendChild(link)}let display=document.getElementById("display");display.appendChild(gameList)}else{initGame(c.getGame(gameNames[0]))}}function initGame(c){GameKeys.init();let target=d3.select("#display");let svg=target.append("svg").attr("class","gameDisplay");svg.append("rect").attr("class","gameBackground").attr("width","100%").attr("height","100%");let child=svg.append("g").attr("class","gameDisplay");svg.call(d3.behavior.zoom().translate([0,0]).scale(1).scaleExtent([0.125,8]).on("zoom",function(){child.attr("transform","translate("+d3.event.translate[0]+","+d3.event.translate[1]+") scale("+d3.event.scale+")")}));let fps=svg.append("text").attr("x",5).attr("y",20).attr("font-family","sans-serif").attr("font-size","20px").attr("fill","black").text("123");svg=child.append("g").attr("class","gameDisplay");let xScale=target[0][0].clientWidth;let yScale=target[0][0].clientHeight;scale=Math.min(xScale,yScale);svg.attr("transform","translate("+(xScale/2)+","+(yScale/2)+") scale("+scale+","+-scale+")");GameKeys.targetPt=Vector2d.xy(0,1);svg.on("mousemove",function(){let point=d3.mouse(this);GameKeys.targetPt=Vector2d.a(point);mouse.attr("cx",GameKeys.targetPt.x).attr("cy",GameKeys.targetPt.y)});svg=svg.append("g").attr("class","gameDisplay");svg.append("rect").attr("x",-10).attr("y",-2).attr("width",20).attr("height",12).attr("fill","white").attr("fill-opacity","0.5");let gridLines=[0];let gridMin=-5;let gridMax=5;svg.selectAll(".xTicks").data(gridLines).enter().append("line").attr("class","xTicks").attr("x1",function(e){return e}).attr("y1",gridMin).attr("x2",function(e){return e}).attr("y2",gridMax).attr("stroke","rgba(0, 0, 0, 0.20)").attr("stroke-width",1/scale);svg.selectAll(".yTicks").data(gridLines).enter().append("line").attr("class","yTicks").attr("x1",gridMin).attr("y1",function(e){return e}).attr("x2",gridMax).attr("y2",function(e){return e}).attr("stroke","rgba(0, 0, 0, 0.20)").attr("stroke-width",1/scale);let mouse=svg.append("circle").attr("stroke-width",2/scale).attr("fill","green").attr("fill-opacity","1.0").attr("stroke","black").attr("stroke-opacity","1.0").attr("r",0.01);c.setup(svg);let frameCount=30;let frameTimes=Array.apply(null,new Array(frameCount)).map(Number.prototype.valueOf,0);let frameIndex=0;let frameSum=0;let lastTime=new Date().valueOf();let gametimer=setInterval(function(){let nowTime=new Date().valueOf();frameSum-=frameTimes[frameIndex];frameTimes[frameIndex]=nowTime-lastTime;frameSum+=frameTimes[frameIndex];frameIndex=(frameIndex+1)%frameCount;lastTime=nowTime;let frameRate=frameCount/(frameSum/1000);fps.text(frameRate.toPrecision(5)+" fps");c.play();Manager.update();Manager.paint()},1000*deltaTime)}let GameContainer=function(){let _=Object.create(Container);_.addGame("Play with Gravity",function(){let ship;return{setup:function(c){ship=Object.create(Ship).init("Player 1",Vector2d.zero(),0).makeGeometry(c);Manager.setGravity(function(f,e){if(f.position.y>0){let scale=Math.pow(Math.min(f.position.y/0.25,1),0.5);f.applyAcceleration(Vector2d.xy(0,Constants.G*scale))}else{if(f.velocity.y<-1){ship.stun(3)}if(f.lastPosition.y>0.01){f.position=f.lastPosition.add(f.velocity.scale(f.position.y/f.velocity.y))}else{f.position.x=f.lastPosition.x;f.position.y=f.position.y/2}}})},play:function(){let deltaSpinPosition=ship.pointAt(GameKeys.targetPt);if(GameKeys.isDown(GameKeys.codes.upArrow)){let targetGo=GameKeys.targetPt.subtract(ship.position);ship.thrust(1,1)}},finish:function(){Manager.setGravity(null)}}}());return _}();