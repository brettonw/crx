"use strict";Math.sgn=function(a){return(a<0)?-1:((a>0)?1:0)};Math.clamp=function(c,b,a){return Math.max(Math.min(c,a),b)};var Constants={G:-9.8};var Vector2d=function(){var a=Object.create(null);var b=function(c,e){var d=Object.create(a);d.x=c;d.y=e;return d};a.a=function(c){return b(c[0],c[1])};a.xy=function(c,d){return b(c,d)};a.v=function(c){return b(c.x,c.y)};a.angle=function(c){return b(Math.cos(c),Math.sin(c))};a.zero=function(){return b(0,0)};a.one=function(){return b(1,1)};a.add=function(c){return b(this.x+c.x,this.y+c.y)};a.subtract=function(c){return b(this.x-c.x,this.y-c.y)};a.scale=function(c){return b(this.x*c,this.y*c)};a.dot=function(c){return(this.x*c.x)+(this.y*c.y)};a.cross=function(c){return(this.x*c.y)-(this.y*c.x)};a.normSq=function(){return this.dot(this)};a.norm=function(){return Math.sqrt(this.normSq())};a.normalize=function(){var c=this.norm();this.copy(this.scale(1/c));return c};a.normalized=function(){return this.scale(1/this.norm())};a.perpendicular=function(){return b(-this.y,this.x)};a.reflect=function(c,d){return c.subtract(d.scale(c.dot(d)*2))};a.toString=function(){return this.x+","+this.y};a.copy=function(c){this.x=c.x;this.y=c.y};return a}();var Particle=function(){var a=Object.create(null);a.reset=function(b){this.position=b;this.velocity=Vector2d.zero();this.force=Vector2d.zero()};a.init=function(e,c,b,d){this.name=e;this.radius=b;this.mass=Math.PI*b*b*d;this.reset(c);return this};a.applyForce=function(b){this.force=this.force.add(b)};a.applyAcceleration=function(b){var c=b.scale(this.mass);this.applyForce(c)};a.applyDamping=function(b){this.applyAcceleration(this.velocity.scale(b/deltaTime))};a.applyFunction=function(b){b(this)};a.makeGeometry=function(b){this.svg=b.append("circle").attr("stroke-width",2/scale).attr("fill","red").attr("fill-opacity","1.0").attr("stroke","black").attr("stroke-opacity","1.0").attr("r",this.radius);return this};a.update=function(b){var c=this.force.scale(b/this.mass);this.force=Vector2d.zero();this.position=this.position.add((c.scale(0.5).add(this.velocity)).scale(b));this.velocity=this.velocity.add(c)};a.paint=function(){this.svg.attr("cx",this.position.x).attr("cy",this.position.y)};return a}();var Thing=function(){var a=Object.create(null);a.geometry=function(){var c=Object.create(null);c.density=3183;var b=function(d){return Math.sqrt(d/(Math.PI*c.density))};c.points=[{pt:Vector2d.xy(-0.05,0.05),radius:b(1)},{pt:Vector2d.zero(),radius:b(1)},{pt:Vector2d.xy(-0.05,-0.05),radius:b(1)},{pt:Vector2d.xy(0.1,0),radius:b(1)}];c.constraints=[[0,1],[1,2],[2,3],[3,0],[3,1]];c.computeXAxis=function(e){var d=e[0].position.add(e[2].position).scale(0.5);return e[3].position.subtract(d).normalized()};return c}();a.updateFrameOfReference=function(j){var m=this.particles;var h=m.length;var k=this.geometry;var l=k.points;var g=Vector2d.zero();for(var f=0;f<h;++f){g=g.add(m[f].position)}g=g.scale(1/h);this.velocity=g.subtract(this.position).scale(1/j);this.position=g;var d=k.computeXAxis(m);var e=Math.atan2(d.y,d.x);var c=e-this.spinPosition;while(c>Math.PI){c-=(Math.PI*2)}while(c<-Math.PI){c+=(Math.PI*2)}this.spinVelocity=c/j;this.spinPosition=e;var b=d.perpendicular();for(var f=0;f<h;++f){m[f].position=g.add(d.scale(l[f].pt.x)).add(b.scale(l[f].pt.y))}};a.reset=function(c,b){var h=this.particles;var g=h.length;var f=this.geometry.points;var j=Vector2d.angle(b);var d=j.perpendicular();for(var e=0;e<g;++e){h[e].reset(c.add(j.scale(f[e].pt.x)).add(d.scale(f[e].pt.y)))}this.position=c;this.velocity=Vector2d.zero();this.spinPosition=b;this.spinVelocity=0;this.updateFrameOfReference(deltaTime)};a.init=function(e,j,h){this.name=e;this.mass=0;var q=this.particles=[];var n=this.geometry;var p=n.points;for(var g=0,l=p.length;g<l;++g){var k=Object.create(Particle).init(e+"-"+g,Vector2d.zero(),p[g].radius,n.density);this.mass+=k.mass;q.push(Manager.addParticle(k))}var f=n.constraints;for(var g=0,l=f.length;g<l;++g){var o=f[g][0];var m=f[g][1];var d=q[o].id;var c=q[m].id;Manager.addConstraint(d,c,p[o].pt.subtract(p[m].pt).norm(),0.5,2)}this.reset(j,h);Manager.addThing(this);return this};a.makeGeometry=function(c){var f=this.particles;var e=f.length;for(var d=0;d<e;++d){f[d].makeGeometry(c)}var b=f[0].position.toString();for(var d=1;d<e;++d){b+=" "+f[d].position.toString()}this.svg=c.append("polygon").attr("fill","red").attr("fill-opacity",0.33).attr("points",b);this.svgLine=c.append("line").attr("stroke","blue").attr("stroke-opacity",0.33).attr("stroke-width",2/scale);return this};a.update=function(b){this.updateFrameOfReference(b)};a.paint=function(){this.svg.attr("transform","translate("+this.position.x+","+this.position.y+") rotate("+(this.spinPosition*(180/Math.PI))+", 0, 0)");this.svgLine.attr("transform","translate("+this.position.x+","+this.position.y+")").attr("x1",0).attr("y1",0).attr("x2",this.velocity.x).attr("y2",this.velocity.y);var d=this.particles;for(var b=0,c=d.length;b<c;++b){d[b].paint()}};return a}();var Ship=function(){var a=Object.create(Thing);a.init=function(e,d,c){Object.getPrototypeOf(a).init.call(this,e,Vector2d.zero(),0);this.stunnedTime=0;this.thrustRatio=1.1*((this.particles.length*-Constants.G)/2);this.thrustRatio*=0.1;this.learn();this.reset(d,c);return this};a.learn=function(){this.reset(Vector2d.zero(),0);var g=this.spinVelocity;var d=0;var f=0;var e=this;var c=function(){var k=5;for(var j=0;j<k;++j){Manager.update()}var h=Math.abs(e.spinVelocity-g)/(deltaTime*k);g=e.spinVelocity;d+=h;++f;return h};this.thrust(-1,1);c();this.thrust(-1,1);c();this.thrust(-1,1);c();this.thrust(1,-1);c();this.thrust(1,-1);c();this.thrust(1,-1);c();this.spinAcceleration=d/f};a.thrust=function(g,e){if(this.stunnedTime<=0){var d=this.thrustRatio*subStepCount;var c=Vector2d.angle(this.spinPosition);var h=c.scale(d*g);var f=c.scale(d*e);this.particles[0].applyAcceleration(h);this.particles[2].applyAcceleration(f)}};a.point=function(k){var g=Math.atan2(k.y,k.x);var c=g-this.spinPosition;while(c>Math.PI){c-=(Math.PI*2)}while(c<-Math.PI){c+=(Math.PI*2)}var i=Math.abs(c);var f=Math.PI*2;var d=1/f;var m=d*(1+i);var h=(c/m);var j=h-this.spinVelocity;var e=j/(this.spinAcceleration*0.5);var l=Math.clamp(e,-1,1);this.thrust(-l,l);return i};a.pointAt=function(c){var d=c.subtract(this.position).normalized();this.point(d)};var b=function(e,l,k,o,g){var h=l.norm()*o;var i=(h>0)?l.scale(1/h):(e.velocity.normSq()>0?e.velocity.normalized():Vector2d.angle(e.spinPosition));var f=i.perpendicular();var n=Math.max(k,h-(i.dot(e.velocity)));var c=2*f.dot(e.velocity);if((Math.abs(n)>0.001)||(Math.abs(c)>0.001)){var m=i.scale(n).add(f.scale(-c));var d=e.point(m);var j=1-(d/(Math.PI*60/180));if(j>0){j=Math.pow(j,g);e.thrust(j,j)}}else{e.point(i)}};a.go=function(c){b(this,c,0,1,2)};a.goTo=function(d){var c=d.subtract(this.position);b(this,c,-1000,0.99,2)};a.stop=function(){b(this,Vector2d.zero(),-1000,1,10)};a.stun=function(c){this.stunnedTime=Math.max(this.stunnedTime,c)};a.update=function(c){Object.getPrototypeOf(a).update.call(this,c);this.stunnedTime-=c};return a}();var Manager=function(){var b=Object.create(null);var e=[];var d=0;b.addParticle=function(j){var i=d++;e.push(j);j.id=i;return j};b.removeParticle=function(i){delete e[i]};var h=[];var c=0;b.addConstraint=function(j,i,n,m,l){var o=c++;h.push({a:j,b:i,length:n,damping:m,k:l});return o};b.removeConstraint=function(i){delete h[i]};var g=[];var a=0;b.addThing=function(i){var j=a++;g.push(i);return j};b.removeThing=function(i){delete g[i]};b.updateParticles=function(i){e.forEach(function(l,j,k){l.update(i)});h.forEach(function(j,o,p){var u=e[j.a];var s=e[j.b];var x=u.position.subtract(s.position);var k=x.normalize();var l=u.velocity.subtract(s.velocity);var w=l.dot(x);var m=u.mass+s.mass;var r=j.damping*(u.mass/m)*w*m/i;var q=j.damping*(s.mass/m)*w*m/i;var n=j.k*(k-j.length);var v=n+r;var t=n+q;u.applyForce(x.scale(-v));s.applyForce(x.scale(t))})};b.updateThings=function(i){g.forEach(function(k,j,l){k.update(i)})};var f=null;b.setGravity=function(i){f=i};b.applyGravity=function(i){if(f!==null){e.forEach(function(l,j,k){f(l,i)})}};b.update=function(){for(var j=0;j<subStepCount;++j){this.updateParticles(subDeltaTime);this.applyGravity(subDeltaTime)}this.updateThings(deltaTime)};b.paint=function(){g.forEach(function(j,i,k){j.paint()})};return b}();var GameKeys=function(){var a=Object.create(null);a.codes={backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,"break":19,capsLock:20,escape:27,pageUp:33,pageDown:34,end:35,home:36,leftArrow:37,upArrow:38,rightArrow:39,downArrow:40,insert:45,"delete":46,"0":48,"1":49,"2":50,"3":51,"4":52,"5":53,"6":54,"7":55,"8":56,"9":57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,leftWindow:91,rightWindow:92,select:93,numpad0:96,numpad1:97,numpad2:98,numpad3:99,numpad4:100,numpad5:101,numpad6:102,numpad7:103,numpad8:104,numpad9:105,multiply:106,add:107,subtract:109,decimalPoint:110,divide:111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numLock:144,scrollLock:145,colon:186,equalSign:187,comma:188,dash:189,period:190,forwardSlash:191,graveAccent:192,openBracket:219,backSlash:220,closeBracket:221,quote:222};a.init=function(){this.down=Object.create(null);var b=document.body;var c=this;b.onkeydown=function(d){c.down[d.keyCode]=true};b.onkeyup=function(d){c.down[d.keyCode]=false}};a.isDown=function(b){return(b in this.down)?this.down[b]:false};return a}();var Container=function(){var a=Object.create(null);a.addGame=function(c,b){if(("games" in this)==false){this.games=Object.create(null);this.prefix="A".charCodeAt(0)}c="("+String.fromCharCode(this.prefix++)+") "+c;this.games[c]=b};a.getGameNames=function(){var b=[];for(var c in this.games){b.push(c)}b.sort();return b};a.getGame=function(b){return this.games[b]};return a}();var scale=1;var deltaTime=1/60;var subStepCount=4;var subDeltaTime=deltaTime/subStepCount;function preInitGame(a){var g=a.getGameNames();var j=new String(window.location);console.log("URL ("+j+")");var b=j.search("#");if(b>=0){var d=j.substring(b+1);var k=d.toLowerCase().charCodeAt(0)-"a".charCodeAt(0);if((k>=0)&&(k<g.length)){console.log("URL ("+j+") Target ("+d+") at index ("+k+")");g=[g[k]]}}if(g.length>1){var h=document.createElement("div");h.className="gameList";h.id="gameList";for(var c=0;c<g.length;++c){var f=document.createElement("div");f.innerHTML=g[c];f.onclick=function(){this.parentNode.parentNode.removeChild(this.parentNode);initGame(a.getGame(this.innerHTML))};h.appendChild(f)}var e=document.getElementById("display");e.appendChild(h)}else{initGame(a.getGame(g[0]))}}function initGame(q){GameKeys.init();var n=d3.select("#display");var k=n.append("svg").attr("class","gameDisplay");k.append("rect").attr("class","gameBackground").attr("width","100%").attr("height","100%");var f=k.append("g").attr("class","gameDisplay");k.call(d3.behavior.zoom().translate([0,0]).scale(1).scaleExtent([0.125,8]).on("zoom",function(){f.attr("transform","translate("+d3.event.translate[0]+","+d3.event.translate[1]+") scale("+d3.event.scale+")")}));var h=k.append("text").attr("x",5).attr("y",20).attr("font-family","sans-serif").attr("font-size","20px").attr("fill","black").text("123");k=f.append("g").attr("class","gameDisplay");var p=n[0][0].clientWidth;var g=n[0][0].clientHeight;scale=Math.min(p,g);k.attr("transform","translate("+(p/2)+","+(g/2)+") scale("+scale+","+-scale+")");GameKeys.targetPt=Vector2d.xy(0,1);k.on("mousemove",function(){var r=d3.mouse(this);GameKeys.targetPt=Vector2d.a(r);m.attr("cx",GameKeys.targetPt.x).attr("cy",GameKeys.targetPt.y)});k=k.append("g").attr("class","gameDisplay");k.append("rect").attr("x",-10).attr("y",-2).attr("width",20).attr("height",12).attr("fill","white").attr("fill-opacity","0.5");var j=[0];var e=-5;var l=5;k.selectAll(".xTicks").data(j).enter().append("line").attr("class","xTicks").attr("x1",function(r){return r}).attr("y1",e).attr("x2",function(r){return r}).attr("y2",l).attr("stroke","rgba(0, 0, 0, 0.20)").attr("stroke-width",1/scale);k.selectAll(".yTicks").data(j).enter().append("line").attr("class","yTicks").attr("x1",e).attr("y1",function(r){return r}).attr("x2",l).attr("y2",function(r){return r}).attr("stroke","rgba(0, 0, 0, 0.20)").attr("stroke-width",1/scale);var m=k.append("circle").attr("stroke-width",2/scale).attr("fill","green").attr("fill-opacity","1.0").attr("stroke","black").attr("stroke-opacity","1.0").attr("r",0.01);q.setup(k);var d=30;var o=Array.apply(null,new Array(d)).map(Number.prototype.valueOf,0);var c=0;var b=0;var a=new Date().valueOf();var i=setInterval(function(){var s=new Date().valueOf();b-=o[c];o[c]=s-a;b+=o[c];c=(c+1)%d;a=s;var r=d/(b/1000);h.text(r.toPrecision(5)+" fps");q.play();Manager.update();Manager.paint()},1000*deltaTime)}var GameContainer=function(){var a=Object.create(Container);a.addGame("Play with Gravity",function(){var b;return{setup:function(c){b=Object.create(Ship).init("Player 1",Vector2d.zero(),0).makeGeometry(c);Manager.setGravity(function(i,d){if(i.position.y>0){var g=Math.pow(Math.min(i.position.y/0.25,1),0.5);i.applyAcceleration(Vector2d.xy(0,Constants.G*g))}else{var h=Vector2d.xy((-0.5/d)*i.velocity.x,0);if(i.velocity.y<0){var f=0.8;h.y=(i.velocity.y*-(1+f))/d;var e=i.velocity.norm()-0.5;if(e>0){b.stun(e*0.5)}}i.applyAcceleration(h);i.position.y=0}})},play:function(){var c=b.pointAt(GameKeys.targetPt);if(GameKeys.isDown(GameKeys.codes.upArrow)){var d=GameKeys.targetPt.subtract(b.position);b.thrust(1,1)}},finish:function(){Manager.setGravity(null)}}}());return a}();