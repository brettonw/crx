"use strict";var Vector2d=function(){var a=Object.create(null);var b=function(c,e){var d=Object.create(a);d.x=c;d.y=e;return d};a.a=function(c){return b(c[0],c[1])};a.xy=function(c,d){return b(c,d)};a.v=function(c){return b(c.x,c.y)};a.angle=function(c){return b(Math.cos(c),Math.sin(c))};a.zero=function(){return b(0,0)};a.one=function(){return b(1,1)};a.add=function(c){return b(this.x+c.x,this.y+c.y)};a.subtract=function(c){return b(this.x-c.x,this.y-c.y)};a.scale=function(c){return b(this.x*c,this.y*c)};a.dot=function(c){return(this.x*c.x)+(this.y*c.y)};a.cross=function(c){return(this.x*c.y)-(this.y*c.x)};a.normSq=function(){return this.dot(this)};a.norm=function(){return Math.sqrt(this.normSq())};a.normalize=function(){var c=this.norm();this.copy(this.scale(1/c));return c};a.normalized=function(){return this.scale(1/this.norm())};a.perpendicular=function(){return b(-this.y,this.x)};a.reflect=function(c,d){return c.subtract(d.scale(c.dot(d)*2))};a.toString=function(){return this.x+","+this.y};a.copy=function(c){this.x=c.x;this.y=c.y};return a}();var Particle=function(){var a=Object.create(null);a.reset=function(b){this.position=b;this.velocity=Vector2d.zero();this.force=Vector2d.zero()};a.init=function(e,c,b,d){this.name=e;this.radius=b;this.mass=Math.PI*b*b*d;this.reset(c);return this};a.applyForce=function(b){this.force=this.force.add(b)};a.applyAcceleration=function(b){var c=b.scale(this.mass);this.applyForce(c)};a.applyDamping=function(b){this.applyAcceleration(this.velocity.scale(b/deltaTime))};a.applyFunction=function(b){b(this)};a.makeGeometry=function(b){this.svg=b.append("circle").attr("stroke-width",2/scale).attr("fill","red").attr("fill-opacity","1.0").attr("stroke","black").attr("stroke-opacity","1.0").attr("r",this.radius);return this};a.update=function(b){var c=this.force.scale(b/this.mass);this.force=Vector2d.zero();this.position=this.position.add((c.scale(0.5).add(this.velocity)).scale(b));this.velocity=this.velocity.add(c)};a.paint=function(){this.svg.attr("cx",this.position.x).attr("cy",this.position.y)};return a}();var Cluster=function(){var a=Object.create(null);var b=[Vector2d.xy(-0.05,0.05),Vector2d.xy(-0.05,-0.05),Vector2d.xy(0.1,0)];a.subStepCount=5;a.updateFrameOfReference=function(){var j=this;var i=this.particles;var g=i[0].position.add(i[1].position).add(i[2].position).scale(1/3);this.velocity=g.subtract(this.position).scale(1/deltaTime);this.position=g;var k=i[0].position.add(i[1].position).scale(0.5);var d=i[2].position.subtract(k).normalized();var c=d.perpendicular();var f=Math.atan2(d.y,d.x);var e=f-this.spinPosition;while(e>Math.PI){e-=(Math.PI*2)}while(e<-Math.PI){e+=(Math.PI*2)}this.spinVelocity=e/deltaTime;this.spinPosition=f;var h=function(l){i[l].position=j.position.add(d.scale(b[l].x)).add(c.scale(b[l].y))};h(0);h(1);h(2)};a.reset=function(d,c){var f=this;var g=Vector2d.angle(c);var e=g.perpendicular();var h=function(j){f.particles[j].reset(d.add(g.scale(b[j].x)).add(e.scale(b[j].y)))};h(0);h(1);h(2);this.position=d;this.velocity=Vector2d.zero();this.spinPosition=c;this.spinVelocity=0;this.updateFrameOfReference()};a.init=function(e,d,c){this.name=e;var g=function(h){var j=0.01,k=300;return Object.create(Particle).init(e+"-"+h,Vector2d.zero(),j,k)};this.particles=[g(0),g(1),g(2)];this.mass=this.particles[0].mass+this.particles[1].mass+this.particles[2].mass;var f=function(i,h){return{a:i,b:h,d:b[i].subtract(b[h]).norm()}};this.constraints=[f(0,1),f(1,2),f(2,0)];this.reset(d,c);return this};a.applyFunction=function(c){c(this.particles[0]);c(this.particles[1]);c(this.particles[2])};a.makeGeometry=function(c){this.particles[0].makeGeometry(c);this.particles[1].makeGeometry(c);this.particles[2].makeGeometry(c);var d=this.particles[0].position.toString()+" "+this.particles[1].position.toString()+" "+this.particles[2].position.toString();this.svg=c.append("polygon").attr("fill","red").attr("fill-opacity",0.33).attr("points",d);this.svgLine=c.append("line").attr("stroke","blue").attr("stroke-opacity",0.33).attr("stroke-width",2/scale);return this};a.update=function(c){var f=this;var g=function(i){var h=function(q){var j=f.constraints[q];var t=f.particles[j.a];var r=f.particles[j.b];var v=t.position.subtract(r.position);var p=v.normalize();var l=t.velocity.subtract(r.velocity);var u=l.dot(v);var n=0.5*0.5*u*(t.mass+r.mass)/i;var s=p-j.d;var m=1;var o=m*s;var w=o+n;t.applyForce(v.scale(-w));r.applyForce(v.scale(w))};h(0);h(1);h(2);f.particles[0].update(i);f.particles[1].update(i);f.particles[2].update(i)};var e=c/this.subStepCount;for(var d=0;d<this.subStepCount;++d){g(e)}};a.paint=function(){this.updateFrameOfReference();this.svg.attr("transform","translate("+this.position.x+","+this.position.y+") rotate("+(this.spinPosition*(180/Math.PI))+", 0, 0)");this.svgLine.attr("transform","translate("+this.position.x+","+this.position.y+")").attr("x1",0).attr("y1",0).attr("x2",this.velocity.x).attr("y2",this.velocity.y);this.particles[0].paint();this.particles[1].paint();this.particles[2].paint()};return a}();var Thing=function(){var a=Object.create(Particle);a.init=function(d,c,b){Object.getPrototypeOf(Thing).init.call(this,d,c,1,1);this.spinMass=this.mass;this.spinPosition=b;this.spinVelocity=0;this.spinForce=0;return this};a.applySpinForce=function(b){this.spinForce+=b};a.applySpinAcceleration=function(c){var b=c*this.spinMass;this.applySpinForce(b)};a.applySpinDamping=function(b){this.applySpinAcceleration(this.spinVelocity*b/deltaTime)};a.makeGeometry=function(b){var e=[Vector2d.xy(0,0),Vector2d.xy(-0.05,0.05),Vector2d.xy(0.1,0),Vector2d.xy(-0.05,-0.05)];var d=e[0].toString();for(var c=1;c<e.length;++c){d+=" "+e[c].toString()}this.svg=b.append("polygon").attr("stroke-width",2/scale).attr("fill","red").attr("fill-opacity","1.0").attr("stroke","black").attr("stroke-opacity","1.0").attr("stroke-linejoin","round").attr("points",d);return this};a.update=function(b){Object.getPrototypeOf(Thing).update.call(this);var c=this.spinForce*(b/this.spinMass);this.spinForce=0;this.spinPosition=this.spinPosition+(((c*0.5)+this.spinVelocity)*b);this.spinVelocity=this.spinVelocity+c;var d=Math.PI*2;while(this.spinPosition>=d){this.spinPosition-=d}while(this.spinPosition<0){this.spinPosition+=d}};a.paint=function(){this.svg.attr("transform","translate("+this.position.x+","+this.position.y+") rotate("+(this.spinPosition*(180/Math.PI))+", 0, 0)")};return a}();var Ship=function(){var a=Object.create(Cluster);a.learn=function(){var g=Cluster.subStepCount;Cluster.subStepCount=20;this.reset(Vector2d.zero(),0);var h=this.spinVelocity;var d=0;var f=0;var e=this;var c=function(){e.update(deltaTime);e.updateFrameOfReference();var i=Math.abs(e.spinVelocity-h)/deltaTime;h=e.spinVelocity;console.log("Velocity: "+h.toPrecision(5)+", Spin Acceleration: "+i.toPrecision(5)+"/frame");d+=i;++f;return i};c();this.thrust(-1,1);c();c();c();c();this.thrust(-1,1);c();c();c();c();this.thrust(1,-1);c();c();c();c();this.spinAcceleration=d/f;console.log("Spin Acceleration: "+this.spinAcceleration);Cluster.subStepCount=g};a.init=function(e,d,c){Object.getPrototypeOf(Ship).init.call(this,e,Vector2d.zero(),0);this.thrustRatio=16;this.rotateRatio=5;this.learn();this.reset(d,c);return this};a.thrust=function(f,d){var c=Vector2d.angle(this.spinPosition);var g=c.scale(this.thrustRatio*f);var e=c.scale(this.thrustRatio*d);this.particles[0].applyAcceleration(g);this.particles[1].applyAcceleration(e)};a.point=function(i){var e=Math.atan2(i.y,i.x);var c=e-this.spinPosition;while(c>Math.PI){c-=(Math.PI*2)}while(c<-Math.PI){c+=(Math.PI*2)}var g=Math.abs(c);var k=0.15*(1+g);var f=(c/k);var h=f-this.spinVelocity;var d=h/this.spinAcceleration;var j=Math.min(Math.max(d,-1),1);this.thrust(-j,j);return g};a.pointAt=function(c){var d=c.subtract(this.position).normalized();this.point(d)};var b=function(e,l,k,o,g){var h=l.norm()*o;var i=(h>0)?l.scale(1/h):(e.velocity.normSq()>0?e.velocity.normalized():Vector2d.angle(e.spinPosition));var f=i.perpendicular();var n=Math.max(k,h-(i.dot(e.velocity)));var c=2*f.dot(e.velocity);if((Math.abs(n)>0.001)||(Math.abs(c)>0.001)){var m=i.scale(n).add(f.scale(-c));var d=e.point(m);var j=1-(d/(Math.PI*0.5));if(j>0){j=Math.pow(j,g);e.thrust(j,j)}}else{e.point(i)}};a.go=function(c){b(this,c,0,1,2)};a.goTo=function(d){var c=d.subtract(this.position);b(this,c,-1000,0.9,4)};a.stop=function(){b(this,Vector2d.zero(),-1000,1,5)};return a}();var scale=1;var deltaTime=1/60;var leftkeydown=false;var upkeydown=false;var rightkeydown=false;var downkeydown=false;function initPage(){var n=document.body;n.onkeydown=function(i){if(i.keyCode==37){leftkeydown=true}if(i.keyCode==38){upkeydown=true}if(i.keyCode==39){rightkeydown=true}if(i.keyCode==40){downkeydown=true}};n.onkeyup=function(i){if(i.keyCode==37){leftkeydown=false}if(i.keyCode==38){upkeydown=false}if(i.keyCode==39){rightkeydown=false}if(i.keyCode==40){downkeydown=false}};var o=d3.select("#display");var l=o.append("svg").attr("class","gameDisplay");l.style("opacity",0.000001).transition().duration(1000).style("opacity",1);l.append("rect").attr("class","gameBackground").attr("width","100%").attr("height","100%");var d=l.append("g").attr("class","gameDisplay");l.call(d3.behavior.zoom().translate([0,0]).scale(1).scaleExtent([0.125,8]).on("zoom",function(){d.attr("transform","translate("+d3.event.translate[0]+","+d3.event.translate[1]+") scale("+d3.event.scale+")")}));var g=l.append("text").attr("x",5).attr("y",20).attr("font-family","sans-serif").attr("font-size","20px").attr("fill","black").text("123");l=d.append("g").attr("class","gameDisplay");var r=o[0][0].clientWidth;var e=o[0][0].clientHeight;scale=Math.min(r,e);l.attr("transform","translate("+(r/2)+","+(e/2)+") scale("+scale+","+-scale+")");var p=Vector2d.xy(0,1);l.on("mousemove",function(){var i=d3.mouse(this);p=Vector2d.a(i);o.attr("cx",p.x).attr("cy",p.y)});l=l.append("g").attr("class","gameDisplay");l.append("rect").attr("x",-10).attr("y",-2).attr("width",20).attr("height",12).attr("fill","white").attr("fill-opacity","0.5");var k=[0];var c;var m;for(var j=1;j<25;++j){var q=0.05*j;c=-q;m=q;k=[c].concat(k).concat([m])}l.selectAll(".xTicks").data(k).enter().append("line").attr("class","xTicks").attr("x1",function(i){return i}).attr("y1",c).attr("x2",function(i){return i}).attr("y2",m).attr("stroke","rgba(0, 0, 0, 0.20)").attr("stroke-width",1/scale);l.selectAll(".yTicks").data(k).enter().append("line").attr("class","yTicks").attr("x1",c).attr("y1",function(i){return i}).attr("x2",m).attr("y2",function(i){return i}).attr("stroke","rgba(0, 0, 0, 0.20)").attr("stroke-width",1/scale);var o=l.append("circle").attr("stroke-width",2/scale).attr("fill","green").attr("fill-opacity","1.0").attr("stroke","black").attr("stroke-opacity","1.0").attr("r",0.01);var f=Object.create(Ship).init("Ship 1",Vector2d.zero(),0).makeGeometry(l);var a=0;var b;var h=setInterval(function(){if(a++==0){b=new Date();g.text("0 fps")}else{var i=new Date();var v=i.valueOf()-b.valueOf();var t=v/1000;var s=a/t;g.text(s.toPrecision(5)+" fps")}if(upkeydown){var u=p.subtract(f.position);f.go(u)}else{if(downkeydown){f.applyFunction(function(w){w.applyDamping(-0.5)})}else{f.stop()}}if(false){f.applyFunction(function(x){if(x.position.y>0.5){x.applyAcceleration(Vector2d.xy(0,-9.8))}else{if(x.position.y>0){var w=0.5-x.position.y;x.applyAcceleration(Vector2d.xy(0,-9.8*w));x.applyDamping(-w)}else{x.applyAcceleration(Vector2d.xy(0,-5*x.position.y));x.applyDamping(-0.5)}}})}f.update(deltaTime);f.paint()},1000*deltaTime)};